version: '3.8'

# openGauss RISC-V 应用展示中心
# 部署在腾讯云服务器上，作为网关和展示网站

services:
  # 展示网站
  showcase:
    build:
      context: ./showcase
      dockerfile: Dockerfile
    container_name: og-showcase
    restart: unless-stopped
    ports:
      - "8080:80"  # 暴露到宿主机8080端口，nginx通过127.0.0.1:8080访问
    networks:
      - showcase-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx 网关
  # 使用 host 网络模式以访问宿主机上的 frp 转发端口
  nginx-gateway:
    build:
      context: ./nginx-gateway
      dockerfile: Dockerfile
    container_name: og-nginx-gateway
    restart: unless-stopped
    network_mode: host  # 使用host网络模式，可以访问宿主机127.0.0.1
    volumes:
      - ./nginx-gateway/nginx.conf:/etc/nginx/nginx.conf:ro
      - /var/www/certbot:/var/www/certbot:ro  # Let's Encrypt 验证目录
      - /etc/letsencrypt:/etc/letsencrypt:ro  # SSL 证书（获取后添加）
      - /etc/ssl/certs/dhparam.pem:/etc/ssl/certs/dhparam.pem:ro  # DH 参数（获取后添加）
    depends_on:
      - showcase
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  showcase-network:
    driver: bridge

