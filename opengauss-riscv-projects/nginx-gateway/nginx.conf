events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    # 根据 referer 选择 assets 的后端
    map $http_referer $assets_backend {
        default messageboard;
        ~*/petclinic petclinic;
    }
    
    # 日志
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;
    
    # 基本配置
    sendfile on;
    tcp_nopush on;
    keepalive_timeout 65;
    client_max_body_size 10M;
    
    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # SSL 配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # Upstream 定义
    upstream showcase {
        server 127.0.0.1:8080 max_fails=3 fail_timeout=30s;
    }
    
    upstream messageboard {
        server 127.0.0.1:8001 max_fails=3 fail_timeout=30s;
    }
    
    upstream petclinic {
        server 127.0.0.1:8002 max_fails=3 fail_timeout=30s;
    }
    
    # 诊疗系统后端API（直接访问后端，绕过前端Nginx）
    upstream petclinic-backend {
        server 127.0.0.1:9966 max_fails=3 fail_timeout=30s;
    }
    
    # 2048游戏前端
    upstream games-frontend {
        server 127.0.0.1:8003 max_fails=3 fail_timeout=30s;
    }
    
    # 2048游戏后端API
    upstream games-backend {
        server 127.0.0.1:8004 max_fails=3 fail_timeout=30s;
    }
    
    upstream go-todo-backend {
        server 127.0.0.1:8005 max_fails=3 fail_timeout=30s;
    }
    
    upstream go-todo-frontend {
        server 127.0.0.1:8006 max_fails=3 fail_timeout=30s;
    }
    
    # Go Library 后端API
    upstream go-library-backend {
        server 127.0.0.1:8007 max_fails=3 fail_timeout=30s;
    }
    
    # Go Library 前端
    upstream go-library-frontend {
        server 127.0.0.1:8008 max_fails=3 fail_timeout=30s;
    }
    
    # Java Shop 后端API
    upstream java-shop-backend {
        server 127.0.0.1:8009 max_fails=3 fail_timeout=30s;
    }
    
    # Java Shop 前端
    upstream java-shop-frontend {
        server 127.0.0.1:8010 max_fails=3 fail_timeout=30s;
    }
    
    # HTTP 服务器 - 重定向到 HTTPS
    server {
        listen 80;
        server_name ogrsig.top www.ogrsig.top;
        
        # Let's Encrypt 验证路径
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }
        
        # 其他所有请求重定向到 HTTPS
        location / {
            return 301 https://$server_name$request_uri;
        }
    }
    
    # HTTPS 服务器
    server {
        listen 443 ssl http2;
        server_name ogrsig.top www.ogrsig.top;
        
        # SSL 证书
        ssl_certificate /etc/letsencrypt/live/ogrsig.top/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/ogrsig.top/privkey.pem;
        
        # SSL 配置
        ssl_dhparam /etc/ssl/certs/dhparam.pem;
        
        # 安全头
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        
        # 自定义错误页面
        error_page 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
            internal;
        }
        
        # 展示网站首页
        location = / {
            proxy_pass http://showcase;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # 展示网站静态资源
        location ~ ^/(index\.html|style\.css|app\.js)$ {
            proxy_pass http://showcase;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            expires 1h;
            add_header Cache-Control "public";
        }
        
        # API 请求（根据 referer 动态路由）
        location ~ ^/(api|stats)/ {
            proxy_pass http://$assets_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # 静态资源和字体文件（根据 referer 动态路由到不同后端）
        location ~ \.(js|css|map|woff|woff2|ttf|eot|svg|png|jpg|jpeg|gif|ico|webp)$ {
            proxy_pass http://$assets_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            expires 1h;
            add_header Cache-Control "public";
        }
        
        # 留言板应用
        location /messageboard {
            proxy_pass http://messageboard/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 5s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
            proxy_next_upstream_tries 1;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
        
        # 诊疗系统API（直接代理到后端，绕过前端Nginx）
        # 这个规则必须在 /petclinic 之前，因为更具体的路径优先
        location ~ ^/petclinic/api/ {
            proxy_pass http://petclinic-backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 30s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
        
        # 宠物诊疗系统前端
        location /petclinic {
            proxy_pass http://petclinic/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 5s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # 2048游戏API（必须在/games/2048之前，因为更具体的路径优先）
        location /games/api/ {
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin * always;
                add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
                add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
                add_header Access-Control-Max-Age 1728000;
                add_header Content-Type 'text/plain charset=UTF-8';
                add_header Content-Length 0;
                return 204;
            }
            
            proxy_pass http://games-backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        }
        
        # 2048游戏前端
        location /games/2048 {
            if ($uri = /games/2048) {
                return 301 /games/2048/;
            }
            rewrite ^/games/2048(/.*)$ $1 break;
            rewrite ^/games/2048$ / break;
            proxy_pass http://games-frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # Go Library API（必须在 /go-library 前端之前）
        location /go-library/api/ {
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin * always;
                add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
                add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 204;
            }
            
            # 重写路径，去掉 /go-library 前缀
            rewrite ^/go-library/api/(.*) /api/$1 break;
            
            proxy_pass http://go-library-backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        }
        
        # Go Library 前端
        location /go-library {
            if ($uri = /go-library) {
                return 301 /go-library/;
            }
            rewrite ^/go-library(/.*)$ $1 break;
            rewrite ^/go-library$ / break;
            proxy_pass http://go-library-frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # Go Todo API（包括认证）
        location /go-todo/api/ {
            proxy_pass http://go-todo-backend/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
            
            if ($request_method = 'OPTIONS') {
                return 204;
            }
        }
        
        # Go Todo 前端
        location /go-todo {
            if ($uri = /go-todo) {
                return 301 /go-todo/;
            }
            rewrite ^/go-todo(/.*)$ $1 break;
            rewrite ^/go-todo$ / break;
            proxy_pass http://go-todo-frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Java Shop API
        location /java-shop/api/ {
            proxy_pass http://java-shop-backend/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
            
            if ($request_method = 'OPTIONS') {
                return 204;
            }
        }
        
        # Java Shop 前端
        location /java-shop {
            if ($uri = /java-shop) {
                return 301 /java-shop/;
            }
            rewrite ^/java-shop(/.*)$ $1 break;
            rewrite ^/java-shop$ / break;
            proxy_pass http://java-shop-frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # 健康检查
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
